{
  "pipelineSpec": {
    "components": {
      "comp-train-and-save-model": {
        "executorLabel": "exec-train-and-save-model",
        "inputDefinitions": {
          "parameters": {
            "dataset_id": {
              "type": "STRING"
            },
            "file_bucket": {
              "type": "STRING"
            },
            "hs_nba_utils_path": {
              "type": "STRING"
            },
            "model_type": {
              "type": "STRING"
            },
            "pipeline_path": {
              "type": "STRING"
            },
            "project_id": {
              "type": "STRING"
            },
            "resource_bucket": {
              "type": "STRING"
            },
            "save_file_name": {
              "type": "STRING"
            },
            "service_type": {
              "type": "STRING"
            },
            "stats_file_name": {
              "type": "STRING"
            },
            "token": {
              "type": "STRING"
            },
            "train_csv": {
              "type": "STRING"
            }
          }
        },
        "outputDefinitions": {
          "artifacts": {
            "metrics": {
              "artifactType": {
                "schemaTitle": "system.Metrics",
                "schemaVersion": "0.0.1"
              }
            },
            "metricsc": {
              "artifactType": {
                "schemaTitle": "system.ClassificationMetrics",
                "schemaVersion": "0.0.1"
              }
            },
            "model": {
              "artifactType": {
                "schemaTitle": "system.Model",
                "schemaVersion": "0.0.1"
              }
            }
          },
          "parameters": {
            "col_list": {
              "type": "STRING"
            },
            "model_uri": {
              "type": "STRING"
            }
          }
        }
      }
    },
    "deploymentSpec": {
      "executors": {
        "exec-train-and-save-model": {
          "container": {
            "args": [
              "--executor_input",
              "{{$}}",
              "--function_to_execute",
              "train_and_save_model"
            ],
            "command": [
              "sh",
              "-c",
              "\nif ! [ -x \"$(command -v pip)\" ]; then\n    python3 -m ensurepip || python3 -m ensurepip --user || apt-get install python3-pip\nfi\n\nPIP_DISABLE_PIP_VERSION_CHECK=1 python3 -m pip install --quiet     --no-warn-script-location 'kfp==1.8.18' && \"$0\" \"$@\"\n",
              "sh",
              "-ec",
              "program_path=$(mktemp -d)\nprintf \"%s\" \"$0\" > \"$program_path/ephemeral_component.py\"\npython3 -m kfp.v2.components.executor_main                         --component_module_path                         \"$program_path/ephemeral_component.py\"                         \"$@\"\n",
              "\nimport kfp\nfrom kfp.v2 import dsl\nfrom kfp.v2.dsl import *\nfrom typing import *\n\ndef train_and_save_model(file_bucket: str\n                        , resource_bucket: str\n                        , service_type: str\n                        , project_id: str\n                        , dataset_id: str\n                        , model_type: str\n                        , train_csv: str\n                        , save_file_name: str\n                        , stats_file_name: str\n                        , pipeline_path: str\n                        , hs_nba_utils_path: str\n                        , metrics: Output[Metrics]\n                        , metricsc: Output[ClassificationMetrics]\n                        , model: Output[Model]\n                        , token: str\n                        )-> NamedTuple(\"output\", [(\"col_list\", list), (\"model_uri\", str)]):\n\n    #### Import Libraries ####\n    import os \n    import gc\n    import sys\n    import time\n    import pickle\n    import pandas as pd\n    import numpy as np\n    import xgboost as xgb\n\n    from pathlib import Path\n    from yaml import safe_load\n\n    from datetime import datetime\n    from google.cloud import storage\n    from google.cloud import bigquery\n\n    telus_purple = '#4B286D'\n    telus_green = '#66CC00'\n    telus_grey = '#F4F4F7'\n\n    # for prod\n    pth_project = Path(os.getcwd())\n    pth_model_config = pth_project / 'model_config.yaml'\n    sys.path.insert(0, pth_project.as_posix())\n\n    #### For wb\n    import google.oauth2.credentials\n    CREDENTIALS = google.oauth2.credentials.Credentials(token)\n    client = bigquery.Client(project=project_id, credentials=CREDENTIALS)\n    job_config = bigquery.QueryJobConfig()\n\n#     #### For prod\n#     client = bigquery.Client(project=project_id)\n#     job_config = bigquery.QueryJobConfig()\n\n\n    def extract_dir_from_bucket(\n        bucket: Any, local_path: Path, prefix: str, split_prefix: str = 'serving_pipeline' \n    ):\n        \"\"\"\n        Download files from a specified bucket to a local path, excluding a specified prefix.\n\n        Parameters:\n        - bucket: The bucket object from which to download files.\n        - local_path: The local path where the files will be downloaded to.\n        - prefix: The prefix to filter the files in the bucket. Only files with this prefix will be downloaded.\n        - split_prefix: The prefix to exclude from the downloaded file paths. Default is 'serving_pipeline'.\n        \"\"\"\n        for blob in bucket.list_blobs(prefix=prefix):\n            if not blob.name.endswith(\"/\"):\n                path = local_path / blob.name.split(f'{split_prefix}/')[-1]\n                str_path = path.as_posix()\n                Path(str_path[:str_path.rindex('/')]).mkdir(parents=True, exist_ok=True)\n                blob.download_to_filename(str_path)\n\n    # download utils and model config locally\n    storage_client = storage.Client()\n    bucket = storage_client.bucket(resource_bucket)\n    # extract_dir_from_bucket(\n    #     bucket, pth_project, f'{stack_name}/{hs_nba_utils_path}', split_prefix='notebook'\n    # ) \n    # extract_dir_from_bucket(\n    #     bucket, pth_project, f'{stack_name}/{pipeline_path}/queries', split_prefix='training_pipeline'\n    # )\n\n    extract_dir_from_bucket(\n        bucket, pth_project, f'{hs_nba_utils_path}', split_prefix='notebook'\n    ) \n\n    blob = bucket.blob(f'{pipeline_path}/model_config.yaml')\n    blob.download_to_filename(pth_model_config)\n\n    # import local modules\n    from hs_nba_utils.modeling.train import train\n    from hs_nba_utils.modeling.evaluate import evaluate\n    from hs_nba_utils.modeling.save_model import save_model\n\n\n    # load model config\n    d_model_config = safe_load(pth_model_config.open())\n\n    # train    \n    df_result, xgb_model = train(file_bucket=file_bucket, \n                service_type=service_type, \n                model_type=model_type, \n                d_model_config=d_model_config, \n                train_csv=train_csv, \n                save_file_name=save_file_name\n                ) \n\n    print('training step successfully completed')\n\n    # evaluate\n    df_stats = evaluate(df_result=df_result, \n                file_bucket=file_bucket, \n                service_type=service_type, \n                model_type=model_type, \n                d_model_config=d_model_config, \n                stats_file_name=stats_file_name\n                )\n\n    print('evaluate step successfully completed')\n\n    # save model \n    col_list, model_uri = save_model(model=xgb_model, \n                file_bucket=file_bucket, \n                service_type=service_type, \n                d_model_config=d_model_config\n                )\n\n    print('save model step successfully completed')\n\n    print(model_uri)\n\n"
            ],
            "image": "northamerica-northeast1-docker.pkg.dev/cio-workbench-image-np-0ddefe/bi-platform/bi-aaaie/images/kfp-pycaret-slim:latest",
            "resources": {
              "cpuLimit": 4.0,
              "memoryLimit": 32.0
            }
          }
        }
      }
    },
    "pipelineInfo": {
      "name": "nba-product-reco-prospects-train-pipeline"
    },
    "root": {
      "dag": {
        "outputs": {
          "artifacts": {
            "train-and-save-model-metrics": {
              "artifactSelectors": [
                {
                  "outputArtifactKey": "metrics",
                  "producerSubtask": "train-and-save-model"
                }
              ]
            },
            "train-and-save-model-metricsc": {
              "artifactSelectors": [
                {
                  "outputArtifactKey": "metricsc",
                  "producerSubtask": "train-and-save-model"
                }
              ]
            }
          }
        },
        "tasks": {
          "train-and-save-model": {
            "cachingOptions": {
              "enableCache": true
            },
            "componentRef": {
              "name": "comp-train-and-save-model"
            },
            "inputs": {
              "parameters": {
                "dataset_id": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "nba_product_reco_prospects"
                    }
                  }
                },
                "file_bucket": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "divg-groovyhoon-pr-d2eab4-default"
                    }
                  }
                },
                "hs_nba_utils_path": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "vertex_pipelines/hs_nba_utils/notebook"
                    }
                  }
                },
                "model_type": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "acquisition"
                    }
                  }
                },
                "pipeline_path": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "vertex_pipelines/hs_nba_prospects/training_pipeline"
                    }
                  }
                },
                "project_id": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "divg-groovyhoon-pr-d2eab4"
                    }
                  }
                },
                "resource_bucket": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "divg-groovyhoon-pr-d2eab4-default"
                    }
                  }
                },
                "save_file_name": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "df_val_exp.csv"
                    }
                  }
                },
                "service_type": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "nba_product_reco_prospects"
                    }
                  }
                },
                "stats_file_name": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "df_stats.csv"
                    }
                  }
                },
                "token": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "ya29.c.c0AY_VpZjq2cqetiDIky-vd3yxl0melWxDtgCLk-pwxCQiyQ-ZQiNOsMDuJhfppMTVYrUoXZ8odzmsYKHKhxcDN1Sl5M8SoFq6y2ikwRN2rG-Up1oHLbFt7ikyBYuVNXIZiFqm6B0a1EjrmrKNND9yPcLEDWc3bYiHTS1fi_Gu4-XaSfZ3v2J1H3WHEYY2XceBtN-_FnnWjwnyd5DvO-YDwopm7_AIbaAJw-5rA7S5n9gl-kt6OrMvGLDzoABsM21IlvhmUj3Ud_0PeE4xNOuY7ZrAWGVaqnAqUDxa2uM1ChOUvj2cWmQBQDRi24jye4aow8xDdok3DK3bIz-MSglIDdjnJ2kA8goICKuOp_aeAfkCfPzuREt9-1X5ZeYPEqY8nrwN396PX2YYjqWQB5cwa8Q8di9QeqbYJn-ynBwe6gb4tW9Uu4u_0B1ip9lzlmm4kiQm2kvbjo9RUpoz2Xtko5SYahrhtVsVkx6ff8mdBUYmb4tgxWuhp2V-9mhuwpw3uFVeYU6JWVg_cRB_Oioc4vBcsS_IRm7-Os7q6JSBVSqYs_RehJ30jqa1BQlpQ6pFrkJ4MIf3V2FMM811OZSkZrxs9szqFp17x7h00XyZS6pMjulYx5n0cO-MZ31lk-I1UquVpBFlvJm6jW6t86jSSo-lypg8tnF458MY6Bhwq6zB4m8m367fyuqSmbkOYsc7o4cnJhgd4mZsqXpqZcS5wO7Rg-Yl9R_aQ_tg1bkQcdBuye9pjisydYhY6OZbR68pRBV91hvw2dtbkn3-JruWv9vI3dwJyXSyMgXu0_8z82X8kQf8qWk5amrpvgkiWeazQmU9oQdUe1v8YSBQ_iMtJxvU2BfiMMiB_r4zffsmRRJtv1qt1XQhRZyu0nztgSX0YRVahF9R0kqIzS31lRvV08ep1vcSJjJ0mipu6OYJzQoZzMYkX7nnWcZ31QV-SxfJ62wgk9FowXIiUw_M4_US_dWidS9g79S4ZicQRvO_1wYlb-1e0zkFF2V"
                    }
                  }
                },
                "train_csv": {
                  "runtimeValue": {
                    "constantValue": {
                      "stringValue": "training_dataset.csv"
                    }
                  }
                }
              }
            },
            "taskInfo": {
              "name": "train-and-save-model"
            }
          }
        }
      },
      "inputDefinitions": {
        "parameters": {
          "file_bucket": {
            "type": "STRING"
          },
          "project_id": {
            "type": "STRING"
          },
          "region": {
            "type": "STRING"
          },
          "resource_bucket": {
            "type": "STRING"
          }
        }
      },
      "outputDefinitions": {
        "artifacts": {
          "train-and-save-model-metrics": {
            "artifactType": {
              "schemaTitle": "system.Metrics",
              "schemaVersion": "0.0.1"
            }
          },
          "train-and-save-model-metricsc": {
            "artifactType": {
              "schemaTitle": "system.ClassificationMetrics",
              "schemaVersion": "0.0.1"
            }
          }
        }
      }
    },
    "schemaVersion": "2.0.0",
    "sdkVersion": "kfp-1.8.18"
  },
  "runtimeConfig": {
    "parameters": {
      "file_bucket": {
        "stringValue": "divg-groovyhoon-pr-d2eab4-default"
      },
      "project_id": {
        "stringValue": "divg-groovyhoon-pr-d2eab4"
      },
      "region": {
        "stringValue": "northamerica-northeast1"
      },
      "resource_bucket": {
        "stringValue": "divg-groovyhoon-pr-d2eab4-default"
      }
    }
  }
}